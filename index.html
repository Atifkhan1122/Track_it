<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetControl - Live Admin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --dark: #001f3f; --accent: #2ecc71; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .main-container { display: flex; flex: 1; }
        #map { flex: 1; background: #e5e3df; }
        .sidebar { width: 280px; background: #f8f9fa; border-left: 1px solid #ddd; padding: 20px; }
        .status-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #car-img { width: 100%; margin-top: 10px; border-radius: 5px; display: none; border: 1px solid #ddd; }
        .btn-photo { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">FleetCloud Live Tracking</h2>
    <div id="connection-status" style="color: #2ecc71;">‚óè System Connected</div>
</div>

<div class="main-container">
    <div id="map"></div>
    <div class="sidebar">
        <div class="status-card">
            <h3>Vehicle Status</h3>
            <p><b>ID:</b> <span id="v-id">car_01</span></p>
            <p><b>Speed:</b> <span id="v-speed">0</span> km/h</p>
            <p><b>Last Update:</b> <span id="v-time">-</span></p>
            <hr>
            <button class="btn-photo" onclick="takePhoto()">üì∏ Request Live Photo</button>
            <img id="car-img" src="">
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWUrPm4JaKr0qDbVB_ukOSFMkSmLiYals",
        databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com",
        projectId: "mytrecker2-b3535",
        appId: "1:638221551050:web:a3e08991be7c5fe0aabb33"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map initialize (Mobile coordinates: 25.4151, 68.3444)
    const map = L.map('map').setView([25.4151, 68.3444], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let marker = L.marker([25.4151, 68.3444]).addTo(map).bindPopup("Gari Yahan Hai");

    // Command for photo
    window.takePhoto = function() {
        set(ref(db, 'commands/car_01/action'), "take_photo");
        alert("Command Sent!");
    };

    // Listen to Firebase
    const vehicleRef = ref(db, 'vehicles/car_01');
    onValue(vehicleRef, (snapshot) => {
        const v = snapshot.val();
        if (v && v.lat && v.lng) {
            // Move marker and map
            const pos = [v.lat, v.lng];
            marker.setLatLng(pos);
            map.panTo(pos);

            // Update UI
            document.getElementById('v-speed').innerText = v.speed || 0;
            document.getElementById('v-time').innerText = v.last_seen || '-';

            // Show photo if available
            if (v.photo) {
                const img = document.getElementById('car-img');
                img.src = v.photo;
                img.style.display = "block";
            }
        } else {
            console.log("Waiting for data from driver...");
        }
    });
</script>
</body>
</html>
