<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetControl Pro - All Vehicles</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #001f3f; --accent: #3498db; --success: #2ecc71; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f7f6; overflow: hidden; }
        
        /* Map Area */
        #map { flex: 1; height: 100%; z-index: 1; }

        /* Sidebar Styling */
        .sidebar { width: 320px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .vehicle-list { flex: 1; overflow-y: auto; padding: 15px; }

        /* Vehicle Card Styling */
        .vehicle-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: 0.3s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .vehicle-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .vehicle-card h3 { margin: 0 0 10px 0; font-size: 18px; color: var(--primary); display: flex; justify-content: space-between; }
        .status-dot { height: 10px; width: 10px; background: var(--success); border-radius: 50%; display: inline-block; }
        
        .info-row { font-size: 13px; color: #666; margin-bottom: 5px; }
        .btn-group { display: flex; gap: 5px; margin-top: 12px; }
        
        .btn-action { flex: 1; border: none; padding: 8px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 11px; transition: 0.2s; }
        .btn-front { background: var(--accent); }
        .btn-back { background: var(--success); }
        .btn-action:active { transform: scale(0.95); }

        .captured-img { width: 100%; border-radius: 5px; margin-top: 10px; border: 1px solid #ddd; display: none; }
        
        /* Geofence Alert on Map */
        .alert-toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 10px 20px; border-radius: 50px; font-weight: bold; z-index: 1000; display: none; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); animation: slideDown 0.5s ease; }
        @keyframes slideDown { from { top: -50px; } to { top: 20px; } }
    </style>
</head>
<body>

<div id="alert-toast" class="alert-toast">‚ö†Ô∏è GARI BOUNDARY SE BAHAR HAI!</div>

<div id="map"></div>

<div class="sidebar">
    <div class="sidebar-header">
        <h2 style="margin:0;">FleetCloud Pro</h2>
        <span style="font-size: 12px; opacity: 0.8;">Live Fleet Tracking System</span>
    </div>
    <div id="vehicle-list" class="vehicle-list">
        <p style="text-align:center; color:#999;">Waiting for drivers to connect...</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCWUrPm4JaKr0qDbVB_ukOSFMkSmLiYals",
        databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com",
        projectId: "mytrecker2-b3535",
        appId: "1:638221551050:web:a3e08991be7c5fe0aabb33"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Default Home Location (Jamshoro/Hyderabad)
    const ghar_lat = 25.4147; 
    const ghar_lng = 68.3442;
    const geofence_radius = 500; 

    // Initialize Map
    const map = L.map('map').setView([ghar_lat, ghar_lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Safe Zone Circle
    const safeZone = L.circle([ghar_lat, ghar_lng], {
        radius: geofence_radius,
        color: '#3498db',
        fillColor: '#3498db',
        fillOpacity: 0.1
    }).addTo(map);

    const markers = {};
    const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    // Global function to request photos
    window.requestPhoto = (id, mode) => {
        const cmd = mode === 'front' ? "take_photo_front" : "take_photo_back";
        set(ref(db, `commands/${id}/action`), cmd);
        alert(`Command sent to ${id}: Requesting ${mode} camera.`);
    };

    // Listen for all vehicle data
    onValue(ref(db, 'vehicles'), (snapshot) => {
        const vehicles = snapshot.val();
        const listContainer = document.getElementById('vehicle-list');
        
        if (!vehicles) return;
        listContainer.innerHTML = ""; // Refresh list

        let anyVehicleOutside = false;

        for (let id in vehicles) {
            const v = vehicles[id];
            const pos = [v.lat, v.lng];

            // 1. Update/Create Marker
            if (!markers[id]) {
                markers[id] = L.marker(pos).addTo(map).bindPopup(`<b>${id}</b>`);
            } else {
                markers[id].setLatLng(pos);
            }

            // 2. Geofence Calculation
            const distance = L.latLng(ghar_lat, ghar_lng).distanceTo(L.latLng(v.lat, v.lng));
            const isOutside = distance > geofence_radius;
            if(isOutside) anyVehicleOutside = true;

            // 3. Create Sidebar Card
            const card = document.createElement('div');
            card.className = "vehicle-card";
            card.innerHTML = `
                <h3>${id} <span class="status-dot"></span></h3>
                <div class="info-row">üìç <b>Dist:</b> ${Math.round(distance)}m from Home</div>
                <div class="info-row">üöÄ <b>Speed:</b> ${v.speed || 0} km/h</div>
                <div class="info-row">üïí <b>Last:</b> ${v.last_seen || '-'}</div>
                <div class="btn-group">
                    <button class="btn-action btn-front" onclick="requestPhoto('${id}', 'front')">FRONT CAM</button>
                    <button class="btn-action btn-back" onclick="requestPhoto('${id}', 'back')">BACK CAM</button>
                </div>
                <img id="img-${id}" class="captured-img" src="${v.photo || ''}" style="display: ${v.photo ? 'block' : 'none'}">
            `;
            
            // Zoom to vehicle on click
            card.onclick = (e) => {
                if(e.target.tagName !== 'BUTTON') map.flyTo(pos, 17);
            };
            
            listContainer.appendChild(card);
        }

        // Global Alert UI
        const toast = document.getElementById('alert-toast');
        if (anyVehicleOutside) {
            toast.style.display = "block";
            safeZone.setStyle({color: 'red', fillColor: 'red'});
            alertSound.play().catch(() => {});
        } else {
            toast.style.display = "none";
            safeZone.setStyle({color: '#3498db', fillColor: '#3498db'});
        }
    });
</script>
</body>
</html>
