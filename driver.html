<!DOCTYPE html>
<html>
<head>
    <title>Free Tracker - Driver</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body style="background:#121212; color:white; text-align:center; font-family:sans-serif; padding:20px;">
    <h2>Tracking Active</h2>
    <div id="status" style="font-size: 20px; margin-top: 20px;">GPS Dhund raha hai...</div>
    <p id="coords" style="color: #888; font-size: 14px;"></p>
    
    <video id="video" style="display:none;" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // 1. Aapki sahi Config
        const firebaseConfig = {
            apiKey: "AIzaSyCWUrPm4JaKr0qDbVB_ukOSFMkSmLiYals",
            databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com",
            projectId: "mytrecker2-b3535",
        };

        // 2. Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // 3. Live Location with Error Handling
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                // Database mein data bhej raha hai
                db.ref('vehicles/car_01').update({
                    lat: lat,
                    lng: lng,
                    speed: Math.round(pos.coords.speed * 3.6) || 0,
                    last_seen: new Date().toLocaleTimeString()
                }).then(() => {
                    document.getElementById('status').innerText = "ðŸŸ¢ Live: Data Bheja ja raha hai";
                    document.getElementById('coords').innerText = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
                }).catch((error) => {
                    document.getElementById('status').innerText = "ðŸ”´ Database Error: " + error.message;
                });

            }, (err) => {
                document.getElementById('status').innerText = "âŒ GPS Permission Denied!";
            }, { 
                enableHighAccuracy: true,
                maximumAge: 0 
            });
        } else {
            document.getElementById('status').innerText = "âŒ Browser GPS support nahi karta";
        }

        // 4. Photo Capture Logic (No Storage - 100% Free)
        db.ref('commands/car_01/action').on('value', (snap) => {
            if(snap.val() === "take_photo") {
                capturePhoto();
            }
        });

        async function capturePhoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                setTimeout(() => {
                    const canvas = document.getElementById('canvas');
                    canvas.width = 320; canvas.height = 240;
                    canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
                    const imageData = canvas.toDataURL('image/jpeg', 0.5); 
                    
                    db.ref('vehicles/car_01/photo').set(imageData); 
                    db.ref('commands/car_01/action').set("idle");
                    stream.getTracks().forEach(track => track.stop());
                }, 2000);
            } catch (e) {
                console.error("Camera Error:", e);
                db.ref('commands/car_01/action').set("error");
            }
        }
    </script>
</body>
</html>
